<div class="spinner" *ngIf="spinner" fxLayout="row" fxLayoutAlign="center center" fxFill>
    <mat-progress-spinner [mode]="mode">
    </mat-progress-spinner>
</div>
<div *ngIf="invoiceObj && !spinner" fxLayout="row" fxLayoutAlign="start stretch" fxFill>
    <div fxFlex="100" fxLayout="column" fxLayoutAlign="start stretch" fxLayoutGap="0.5em">
        <div fxLayout="column" fxLayoutAlign="start stretch">
            <h1 *ngIf="router.url.includes('createInvoice')" class="bold">Create Invoice</h1>
            <h1 *ngIf="router.url.includes('editInvoice')" class="bold">Edit Invoice</h1>
            <h1 *ngIf="router.url.includes('viewInvoice')" class="bold">View Invoice</h1>
        </div>
        <div fxLayout="row" fxLayoutAlign="space-between center">
            <div fxFlex="100" fxLayout="column" fxLayoutAlign="start stretch">
                <mat-card>
                    <form>
                        <mat-card-content [style.overflow-x]="(router.url.includes('viewInvoice')) ? 'hidden' : ''" class="cardHeight">
                            <div class="padding10px" fxLayout="row" fxLayoutAlign="space-between center">
                                <div fxLayout="column" fxLayoutAlign="center start">
                                    <button routerLink="../" mat-raised-button class="primaryBlueBtn whiteColor">
                                        <mat-icon class="font20px">arrow_back</mat-icon> Back To Invoices
                                    </button>
                                </div>
                                <div fxLayoutGap="10px" fxLayout="row" fxLayoutAlign="start center">
                                    <a (click)="downloadPDF(invoiceObj?.blob)" *ngIf="router.url.includes('viewInvoice')" download="{{ 'Invoice - ' + invoiceObj?.name+ '.pdf' }}" [href]="pdfLink" mat-raised-button class="blueBackground whiteColor">
                                        <mat-icon class="font20px">download</mat-icon> Download
                                    </a>
                                    <button *ngIf="router.url.includes('viewInvoice')" type="submit" mat-raised-button class="greyBackground whiteColor" (click)="editInvoice()">
                                        <mat-icon class="font20px">edit_note</mat-icon>Edit
                                    </button>
                                    <button *ngIf="router.url.includes('editInvoice') || router.url.includes('viewInvoice')" type="button" mat-raised-button class="redBackground whiteColor" (click)="deleteInvoice()">
                                        <mat-icon class="font20px">delete</mat-icon>Delete
                                    </button>
                                </div>
                            </div>
                            <div fxLayout="column" fxLayoutAlign="start stretch">
                                <iframe *ngIf="router.url.includes('viewInvoice')" class="iframe" [src]="sanitizePDF(invoiceObj?.blob)">
                                </iframe>
                                <form *ngIf="router.url.includes('createInvoice') || router.url.includes('editInvoice')" #invoiceForm="ngForm">
                                    <div class="container-fluid pt-2 mb-5">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="card border-secondary">
                                                    <div class="card-body">
                                                        <div fxLayout="row" fxLayoutAlign="space-between center">
                                                            <h4 class="card-title">Client Details</h4>
                                                            <mat-form-field *ngIf="router.url.includes('createInvoice')" appearance="legacy">
                                                                <mat-label>Fetch Client Phone Number</mat-label>
                                                                <input required #phoneNumber matInput name="phoneNumber" (keyup)="getClientFromAPI(phoneNumber.value, invoiceForm)" />
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <div class="form-group">
                                                                    <label for="name">Name</label>
                                                                    <input [disabled]="router.url.includes('createInvoice')" required type="text" class="form-control" name="name" id="name" [ngClass]="{'is-invalid': invoiceForm.submitted && CustomerName.invalid}" [(ngModel)]="invoice.customerName" #CustomerName="ngModel"
                                                                        required>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label for="address">Address</label>
                                                                    <textarea [disabled]="router.url.includes('createInvoice')" required class="form-control" name="address" id="address" row="3" [ngClass]="{'is-invalid': invoiceForm.submitted && Address.invalid}" [(ngModel)]="invoice.address" #Address="ngModel" required></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="form-group">
                                                                    <label for="email">Email ID</label>
                                                                    <input [disabled]="router.url.includes('createInvoice')" required type="email" class="form-control" name="email" id="email" [(ngModel)]="invoice.email" required>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label for="contactNo">Contact No.</label>
                                                                    <input [disabled]="router.url.includes('createInvoice')" required type="number" class="form-control" name="contactNo" id="contactNo" [ngClass]="{'is-invalid': invoiceForm.submitted && ContactNo.invalid}" [(ngModel)]="invoice.contactNo" #ContactNo="ngModel"
                                                                        required>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card border-secondary mt-2">
                                                    <div class="card-body">
                                                        <h4 class="card-title d-flex justify-content-between">Invoice Details
                                                            <button type="button" mat-raised-button class="primaryBlueBtn whiteColor bold" (click)=" addProduct()"><mat-icon class="font20px">add</mat-icon>Add Item </button>
                                                        </h4>
                                                        <div *ngIf="invoice.products.length" class="row">
                                                            <table class="table">
                                                                <thead>
                                                                    <tr>
                                                                        <th width="23%">Product</th>
                                                                        <th width="23%">Price</th>
                                                                        <th width="23%">Quantity</th>
                                                                        <th width="23%">Amount (R)</th>
                                                                        <th width="8%">Delete</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr *ngFor="let product of invoice.products; let i=index">
                                                                        <td scope="row">
                                                                            <input required type="text" class="form-control" name="productName{{i}}" [ngClass]="{ 'is-invalid': invoiceForm.submitted && ProductName.invalid}" [(ngModel)]="product.name" #ProductName="ngModel" required>
                                                                        </td>
                                                                        <td>
                                                                            <input required type="number" class="form-control" name="price{{i}}" id="price" [ngClass]="{'is-invalid':invoiceForm.submitted&&ProductPrice.invalid}" [(ngModel)]="product.price" #ProductPrice="ngModel" required>
                                                                        </td>
                                                                        <td>
                                                                            <input required type="number" class="form-control" name="quantity{{i}}" id="quantity" [ngClass]="{ 'is-invalid': invoiceForm.submitted && ProductQty.invalid}" [(ngModel)]="product.qty" #ProductQty="ngModel" required>
                                                                        </td>
                                                                        <td class="align-amount-td">
                                                                            {{product.price * product.qty || ''}}
                                                                        </td>
                                                                        <td class="align-amount-td">
                                                                            <mat-icon (click)="removeItem(i)" class="redColor bold text-center pointer">delete</mat-icon>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card border-secondary mt-2">
                                                    <div class="card-body">
                                                        <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="1em">
                                                            <h4 class="card-title">Additional Details</h4>
                                                            <mat-slide-toggle [fxShow]="(router.url.includes('editInvoice'))" name="paid" #invoice.paid [(ngModel)]="invoice.paid">
                                                                Invoice Paid
                                                            </mat-slide-toggle>
                                                        </div>
                                                        <div class="form-group">
                                                            <textarea class="form-control" name="additionalDetails" rows="3" [(ngModel)]="invoice.additionalDetails"></textarea>
                                                            <div fxLayout="row" fxLayoutAlign="start center" class="mt-3" fxLayoutGap="10px">
                                                                <button *ngIf="router.url.includes('createInvoice')" type="button" [disabled]="!invoiceForm.valid || invoice.products?.length == 0" mat-raised-button class="greyBackground whiteColor" (click)="sendInvoice(invoiceForm.value)">
                                                                    <mat-icon class="font20px">forward_to_inbox
                                                                    </mat-icon>Email Invoice
                                                                </button>
                                                                <button *ngIf="router.url.includes('editInvoice')" type="button" [disabled]="!invoiceForm.valid || invoiceObj?.items?.length == 0 || !invoiceForm.dirty" mat-raised-button class="greyBackground whiteColor" (click)="updateAndEmailInvoice(invoiceForm.value)">
                                                                    <mat-icon class="font20px">forward_to_inbox
                                                                    </mat-icon>Update & Email Invoice
                                                                </button>
                                                                <!-- <button *ngIf="router.url.includes('editInvoice')"  type="button" [disabled]="!invoiceForm.valid || invoiceObj?.items?.length == 0" mat-raised-button class="primaryBlueBtn whiteColor" (click)="updateAndSaveInvoice(invoiceForm.value)">
                                                                    <mat-icon class="font20px">forward_to_inbox
                                                                    </mat-icon>Update & Save Invoice
                                                                </button> -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </mat-card-content>
                    </form>
                </mat-card>
            </div>
        </div>
    </div>
</div>
